<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Fractal-mosaics by s-ben</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Fractal-mosaics</h1>
        <p class="header">Photomosaics 3.0</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/s-ben/Fractal-Mosaics/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/s-ben/Fractal-Mosaics/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/s-ben/Fractal-Mosaics">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/s-ben">s-ben</a></p>


      </header>
      <section>
        <h1>[UNDER CONSTRUCTION]</h1>

<h1>Abstract</h1>

<p>The Fractal Mosaic algorithm is a rotation, scale, and translation invariant photomosaic algorithm.  While traditional photomosaics create a larger image out of smaller square images on a rectangular grid, Fractal Mosaics creates a larger image out of rectangular images that can be placed at arbitrary locations, can be scaled to any size, and can be rotated by any angle.  </p>

<p>This is accomplished with a combination of image search (i.e. image retrieval) algorithms and an image registration algorithm developed with NASA funding by George Wolberg Siavash Zokai at the City College of New York (<a href="http://www.researchgate.net/publication/2830220_Robust_Image_Registration_Using_Log-Polar_Transform/file/d912f51116dedc8a30.pdf">pdf</a>).</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/eye_mosaic_flickr_800pix.jpg?login=s-ben&amp;token=d045d2a20e53d9009700d6829157669f" alt="Alt text">
Figure 1:  Fractal Mosaic created with graffiti image set (best viewed <a href="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/eye_mosaic_flickr_large.jpg?login=s-ben&amp;token=87b09134a5f66d314547e419299a65b7">large</a></p>

<p>Figure 2 shows three traditional photomosaics created using the same image set and target image.  </p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/traditional_mosaic_different_resolutions_800pix.png?login=s-ben&amp;token=5dc052c2ee602a1b7bfd08d525e9d00a" alt="Alt text">
Figure 2:  Traditional Photomosaics using large tiles (left), medium sized tiles (middle), and small tiles (right)</p>

<p>As can be seen, using large tiles (left), finer details are lost.  Using small tiles (right), we capture target image details, but can’t see individual image detail.  Using medium size tiles (middle), we get a compromise between the two.  Fractal Mosaics aims to create mosaics that capture both target image details and individual image details, in an aesthetically interesting way.</p>

<p>By allowing for arbitrary placement, rotation, and scaling of the “library images” (images making up the mosaic), there are an many more possible matches to evaluate.  This allows for larger, often more aesthetically interesting matches than possible with traditional photomosaics.  However, searching such a large solution space on a personal computer presents a challenging problem.  This “paper” presents my solution to this problem (two years worth of unpaid work...).  It explains the algorithm in depth for those wishing to hack the Matlab code.  It should also aid those using the code to create mosaics, as understanding how the algorithm works will help tweak parameters that shape mosaic output.</p>

<h1>Introduction / Problem Statement</h1>

<p>In a traditional photomosaic, the number of possible matches is large but still easily manageable on a modern PC.  The number of possible matches is simply the number of “tiles” (square areas in the target image) times the number of library images.  For each tile, a similarity metric is calculated (root mean squared (rms) error, typically) for every library image.  The library image with the smallest rms error is placed in the mosaic.</p>

<p>In a Fractal Mosaic, the number of possible possible matches is effectively infinite.  For example, let’s say we use 5,000 library images, a 3072 x 1024 pixel target image, and do the following fairly rough quantization of the possible translations, rotations, and scalings:  </p>

<ul>
<li>2 degree rotations (180 possible rotations)</li>
<li>Every fifth pixel is a possible placement location (629,145 possible translations)</li>
<li>50 possible scaling values</li>
</ul><p>This gives us (180 rotations) x (629,145 translations) x (50 scalings) x (5,000 library images) = 28,311,525,000,000 possible matches to search.  Or ~28 trillion matches.  Obviously, a brute force search is not feasible (I tried).</p>

<p>Fractal Mosaics tackles this complexity with three main strategies.  One strategy is inherent in the “Log-polar” image registration algorithm at the core of Fractal Mosaics.  This algorithm uses a coarse-to-fine multi-resolution framework, whereby estimates computed in lower resolution images are used as initial guesses in higher resolution images.  An in-depth explanation of how log polar registration is implemented in Fractal Mosaics is given in the “log-polar registration” section.  </p>

<p>The second main strategy is to use an image search algorithm to filter out library images that are statistically unlikely to produce a match.  Details on this in the ‘Image Search (Retrieval) Filtering’ section.  </p>

<p>The third main strategy for reducing the number of matches evaluated is to look for large matches first, then not look for smaller matches “under” those matches (i.e., don’t look for matches in areas where we’ve already placed an image).  This saves considerable computation.  However, it will cause the algorithm to miss aesthetically better matches under the placed matches.  For this reason, Fractal Mosaics can be configured to also look for alternate matches under placed images.  All matches can optionally be output to PNG files that can be loaded into Photoshop for later compositing. </p>

<p>The following sections will walk you through the main pieces of the Fractal Mosaic algorithm.    </p>

<ul>
<li>Image Registration</li>
<li>Image Search (Retrieval)</li>
<li>Mosaic Rendering</li>
<li>Conclusions / Future Directions</li>
</ul><h1>Image Registration</h1>

<p>Image registration is generally defined as the lining up of images misaligned due to rotation, scale, and position (translation).  The field of image registration is mature, constituting of several decades of research.  The key insight of Fractal Mosaics is that image registration algorithms can be applied to efficiently search the photomosaic solution space.  Instead of evaluating every possible rotation, scaling, and translation for every library image (computationally impossible), we can use image registration to efficiently estimate these parameters.  Once these parameters are estimated, they are used to rotate, scale, and translate the library image in question to best match the target image. A similarity metric (rms error in this case) is applied.  If the rotated, scaled, and translated library image scores high enough on the similarity metric, it is placed in the mosaic.  </p>

<h2>Registration Algorithm Choice</h2>

<p>After an initial survey of the image registration literature, a frequency domain image registration algorithm was evaluated; specifically, Fourier-Mellin-based image registration, as implemented in this <a href="http://www.mathworks.com/matlabcentral/fileexchange/3000-fourier-mellin-based-image-registration-with-gui">Matlab code</a>.  This would have been much more computationally efficient than the spatial domain algorithm eventually chosen, as rotation, scale, and translation are efficiently recovered in one step.  However, this technique proved not robust enough for the photomosaic application.  This is likely because it relies more heavily on the assumption made by all image registration algorithms: that the two images being matched are of the same object/scene.  In photomosaics however, we are matching parts of the target image to random library images.  The assumption that the library images are rotated, scaled, and translated versions of the target image is weak.  </p>

<p>An image registration algorithm that operates in the spatial domain was tried; specifically, the “Log-polar registration” algorithm found in the paper “Robust Image Registration Using Log-Polar Transform” (<a href="http://www.researchgate.net/publication/2830220_Robust_Image_Registration_Using_Log-Polar_Transform/file/d912f51116dedc8a30.pdf">pdf</a>.  This algorithm proved very robust.  And most importantly, it met the main aesthetic criteria: for any two images presented to the algorithm, no matter how dissimilar, it aligned them the way a human would.  To test this claim out for yourself, check out this <a href="http://www.youtube.com/watch?v=fw7deJSLVE4">video showing the algorithm at work</a> matching library images to a target image. </p>

<p>The downside to Log-polar registration is increased computation.  Because Log-polar registration only recovers rotation and scale, to recover translation, it must be applied to every location (pixel) in the target image. The location resulting in the lowest rms error is then chosen as the estimate.  This creates a lot of extra computation.  To mitigate this, the authors of the algorithm use a coarse-to-fine multi-resolution framework, whereby estimates computed in lower resolution images are used as initial guesses in higher resolution images.  The following section details the implementation of Log-polar registration in Fractal Mosaics, which deviates somewhat from the implementation presented in the paper.  </p>

<h2>Log Polar Image Registration</h2>

<p>In “Robust Image Registration Using Log-Polar Transform”, the authors lay out a “two module” approach.  First, a “Log-polar registration” module estimates rotation, scale, and translation.  Then, a second module uses a nonlinear least squares optimization method to refine this estimation and obtain sub-pixel accuracy.  Since Fractal Mosacis does not require sub-pixel accuracy, and the log polar registration module was found to be accurate enough for this application, just the log-polar registration module is implemented.</p>

<h3>Polar Coordinates</h3>

<p>To understand Log-polar registration, we briefly review <a href="http://en.wikipedia.org/wiki/Polar_coordinate_system">polar coordinates</a>.  </p>

<p>When transforming from Cartesian to polar coordinates, each pixel location (x,y) is represented as a radius and angle (r,a), where r is the distance from the center of the image (xc,yc), and a is the angle in degrees from the x-axis.</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/radius_eq_polar.gif?login=s-ben&amp;token=05e5efcd7cad361572bbf941f86ad1f2" alt="equation"></p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/angle_equation_polar.gif?login=s-ben&amp;token=ee4778d991bfe42ea68e377ed9c59f5f" alt="equation"></p>

<p>Figure 3 illustrates the polar transform using an image of Abraham Lincoln.  Here we see a crop of the Lincoln image (a), the Lincoln image rotated by 90 deg (c), and the log-polar transforms of both ((b) and (d)).</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/Polar_transform_500pix.png?login=s-ben&amp;token=2297c64c8a54efd5b9fe4e7f3a62f311" alt="Alt text"></p>

<p>As can be seen, in the polar space, the 90 degree rotation manifests as a circular shift along the x-axis of the polar image (i.e. the angle axis).  If we take the cross-correlation of the polar transformed images ((b) and (d)), the maximum of the cross-correlation gives us the rotation.  However, scale cannot be recovered from the cross-correlation.</p>

<h3>Log-polar Transform</h3>

<p>Here’s where we take advantage of some math magic.  According to the product rule of logarithms,  </p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/log_general_equation.gif?login=s-ben&amp;token=daccda0e863fce8c925880b950d70545" alt="equation"></p>

<p>Assuming we scale an image up by a factor of 3, in the polar space, this is equivalent to multiplying the radius values by 3.</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/polar_scaling_eq.gif?login=s-ben&amp;token=20de8f9d649563130ea241a3573fd5b6" alt="equation"></p>

<p>If we apply the log function to the radius values (i.e. the log-polar transform),</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/log_polar_scale_eq.gif?login=s-ben&amp;token=cc3546e0e40606f5ffbcff3586f42c92" alt="equation"></p>

<p>Scale now manifests as a scalar phase shift (log(3)) in the radius axis (i.e. x-axis).  Rotation still manifests as a phase shift in the angle axis (i.e. y-axis), as it did in the straight polar transform Section.  We can now recover both scale and rotation from the cross-correlation of the log-polar transformed images!  Magic!</p>

<p>Figure 4 shows a crop of the Lincoln image (a), the Lincoln image rotated by 45 deg and scaled up by a factor of 2 (c), and the log-polar transforms of both ((b) and (d)).  </p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/LogPolar_transform_500pix.png?login=s-ben&amp;token=e72f28a8e8855f7484d116120e03fe1b" alt="Alt text"></p>

<p>As can be seen, the 45 deg rotation shows up as a circular shift along the x-axis (i.e. angle axis) and the 2X scaling shows up as a phase shift along the y-axis (i.e. angle axis).</p>

<h3>Rotation and Scale Estimation</h3>

<p>To estimate rotation and scale, we take the cross-correlation of the log-polar transformed images ((b) and (d) in Figure 4).  The maximum of the cross-correlation (dark red peak) corresponds to rotation and scale (equations for calculating rotation and scale from peak can be found in the code).</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/Lincoln_cc.png?login=s-ben&amp;token=22024bc7d3e71e2a15e9fb2d16e9e80b" alt="Alt text"></p>

<p>For computational efficiency, the cross-correlation is computed in the Fourier domain using 2D FFTs,</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/cc_eq.gif?login=s-ben&amp;token=dac60d00b66a927d84272a207994b202" alt="equation"></p>

<p>where L1 and L2 are the log-polar transformed library and target images, respectively.</p>

<h3>Recovering Translation</h3>

<p>As mentioned previously, Log-polar registration does not recover translation.  It assumes the two images presented to it line up, except for rotation and scale differences.  To recover translation, the algorithm must be applied to every location (pixel).  The translation resulting in the best match (i.e. lowest rms error) is then chosen as the translation estimate.  This makes log-polar registration fairly computationally expensive compared to other registration techniques.</p>

<p>To reduce computation, the authors of log-polar registration implement a coarse-to-fine multi-resolution framework, whereby estimates computed in lower resolution images are used as initial guesses in higher resolution images.  This framework was tweaked in several places to apply it to Fractal Mosaics, as outlined below in the ‘Image Registration Algorithm Steps’ section.</p>

<h3>Image Registration Algorithm Steps</h3>

<ol>
<li>Create low resolution versions of target image</li>
</ol><p>For each “level” (levels are explained shortly), we require five different resolutions of the target image.</p>

<p>First, we create the lowest resolution version of the target image.  Because 8x8 images were found (in this author’s experiments), to be the lowest resolution images capable of producing meaningful rotation and scale estimates, the lowest resolution target image is composed of 8x8 images, or “tiles”.   For example, Figure 6 shows a target image of Abraham Lincoln at full resolution (3072 x 2606 pixels), and an 8x8 resolution version (24x20 pixels).</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/Lincoln_8x8_crop_illustrate.png?login=s-ben&amp;token=f402b26d3651f713d3009bd7159b4722" alt="Alt text"></p>

<p>Note that the low resolution version is three 8x8 “tiles” high.  In other words, the largest possible images in the final mosaic will be approximately 1/3 of the mosaic height.  This is a reasonable assumption, as we’re very unlikely to find a random library image that exactly matches more than a third of the target image.</p>

<p>Next, we create the intervening resolutions. These resolutions are powers of two derived from the 8x8 image, up to 128x128.  I.e., we have an 8x8 resolution image, as shown in Figure 6, a 16x16 resolution image which is four times the size of the 8x8 resolution image, a 32x32 resolution image which is four times the size of the 8x8 image, and so on, down to 128x128.  128x128 is the highest resolution we perform image registration on because higher resolutions do not produce meaningful refinements of scale and rotation and are therefore a waste of computation.  The original library images (used to render the final mosaic) are 256x256 pixels.</p>

<p>Note that while black and white images are used in this example, the same math applies to color.  The same steps are simply applied to each color channel (R,G,B) in parallel.</p>

<ol>
<li>Perform Log-polar registration on each pixel</li>
</ol><p>Since Fractal Mosaics doesn’t perform “wrapping” of pixels on the boundary of the target image, we only evaluate pixels in the “valid pixel area” (red box in Figure 7).</p>

<p><img src="https://raw.github.com/s-ben/Fractal-Mosaics/gh-pages/images/Lincoln_8x8_valid_pixel_area.png?login=s-ben&amp;token=caf1d7368f18245b1e7904770de7925b" alt="Alt text"></p>

<p>For each location (x,y) in the valid pixel area, we perform the following steps:</p>

<h3>Welcome to GitHub Pages.</h3>

<p>This automatic page generator is the easiest way to create beautiful pages for all of your projects. Author your page content here using GitHub Flavored Markdown, select a template crafted by a designer, and publish. After your page is generated, you can check out the new branch:</p>

<pre><code>$ cd your_repo_root/repo_name
$ git fetch origin
$ git checkout gh-pages
</code></pre>

<p>If you're using the GitHub for Mac, simply sync your repository and you'll see the new branch.</p>

<h3>Designer Templates</h3>

<p>We've crafted some handsome templates for you to use. Go ahead and continue to layouts to browse through them. You can easily go back to edit your page before publishing. After publishing your page, you can revisit the page generator and switch to another theme. Your Page content will be preserved if it remained markdown format.</p>

<h3>Rather Drive Stick?</h3>

<p>If you prefer to not use the automatic generator, push a branch named <code>gh-pages</code> to your repository to create a page manually. In addition to supporting regular HTML content, GitHub Pages support Jekyll, a simple, blog aware static site generator written by our own Tom Preston-Werner. Jekyll makes it easy to create site-wide headers and footers without having to copy them across every page. It also offers intelligent blog support and other advanced templating features.</p>

<h3>Authors and Contributors</h3>

<p>You can <a href="https://github.com/blog/821" class="user-mention">@mention</a> a GitHub username to generate a link to their profile. The resulting <code>&lt;a&gt;</code> element will link to the contributor's GitHub Profile. For example: In 2007, Chris Wanstrath (<a href="https://github.com/defunkt" class="user-mention">@defunkt</a>), PJ Hyett (<a href="https://github.com/pjhyett" class="user-mention">@pjhyett</a>), and Tom Preston-Werner (<a href="https://github.com/mojombo" class="user-mention">@mojombo</a>) founded GitHub.</p>

<h3>Support or Contact</h3>

<p>Having trouble with Pages? Check out the documentation at <a href="http://help.github.com/pages">http://help.github.com/pages</a> or contact <a href="mailto:support@github.com">support@github.com</a> and we’ll help you sort it out.</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>